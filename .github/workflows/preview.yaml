name: Deploy Preview

on:
  push:
    branches-ignore:
      - main  # This correctly excludes the 'main' branch

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  db-migrate:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
       - name: Check out repository
         uses: actions/checkout@v4

       - name: Set up Node.js
         uses: actions/setup-node@v4
         with:
          node-version: '20'

       - name: Install pnpm
         run: npm install -g pnpm

       - name: Install Vercel CLI
         run: | 
            pnpm install vercel@latest

       - name: Install dependencies
         run: pnpm install

       - name: Link Vercel Project
         run: pnpm vercel link --token=${{ env.VERCEL_TOKEN }}  --confirm
         env:
           VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

       - name: Pull Vercel Environment Information
         run: |
            pnpm vercel env pull .env --environment=preview --token=${{ env.VERCEL_TOKEN }}
            cat .env 

       - name: Run Migrations
         run: pnpm db:migrate

